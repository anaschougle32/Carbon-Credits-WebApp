{% extends 'bank/base.html' %}
{% load static %}

{% block title_page %}Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}
{% block page_description %}Overview of carbon credit trading and market activity{% endblock %}

{% block bank_content %}
<!-- Quick Stats -->
<div class="quick-stats">
    <div class="stat-card">
        <div class="stat-title">Total Carbon Credits</div>
        <div class="stat-value">{{ total_credits|default:"0" }}</div>
        <div class="stat-change {% if credit_change >= 0 %}positive{% else %}negative{% endif %}">
            {% if credit_change >= 0 %}↑{% else %}↓{% endif %}
            {{ credit_change|cut:'-' }}% from last month
        </div>
    </div>

            <div class="stat-card">
        <div class="stat-title">Active Employers</div>
        <div class="stat-value">{{ active_employers|default:"0" }}</div>
        <div class="stat-change {% if employer_change >= 0 %}positive{% else %}negative{% endif %}">
            {% if employer_change >= 0 %}↑{% else %}↓{% endif %}
            {{ employer_change|cut:'-' }}% from last month
                </div>
            </div>
            
            <div class="stat-card">
        <div class="stat-title">Average Credit Price</div>
        <div class="stat-value">${{ avg_price|default:"0.00" }}</div>
        <div class="stat-change {% if price_change >= 0 %}positive{% else %}negative{% endif %}">
            {% if price_change >= 0 %}↑{% else %}↓{% endif %}
            {{ price_change|cut:'-' }}% from last month
                </div>
            </div>
            
            <div class="stat-card">
        <div class="stat-title">Monthly Trading Volume</div>
        <div class="stat-value">${{ monthly_volume|default:"0.00" }}</div>
        <div class="stat-change {% if volume_change >= 0 %}positive{% else %}negative{% endif %}">
            {% if volume_change >= 0 %}↑{% else %}↓{% endif %}
            {{ volume_change|cut:'-' }}% from last month
                    </div>
                </div>
            </div>
            
<!-- Main Content Grid -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Market Activity Chart -->
    <div class="lg:col-span-2 bg-white rounded-lg shadow">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">Market Activity</h2>
                <select class="text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option>Last 7 Days</option>
                    <option>Last 30 Days</option>
                    <option>Last 90 Days</option>
                </select>
                    </div>
            <div class="h-80" id="market-activity-chart">
                <!-- Chart will be rendered here -->
            </div>
        </div>
    </div>
    
    <!-- Pending Approvals -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">Pending Approvals</h2>
                {% if pending_approvals %}
                <a href="{% url 'bank:bank_approvals' %}" class="text-sm text-blue-600 hover:text-blue-800">View all</a>
                {% endif %}
                </div>
                
            {% if pending_approvals %}
            <div class="space-y-4">
                {% for approval in pending_approvals %}
                <div class="flex items-start p-4 bg-gray-50 rounded-lg">
                    <div class="flex-shrink-0">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full {% if approval.type == 'registration' %}bg-purple-100 text-purple-600{% else %}bg-blue-100 text-blue-600{% endif %}">
                            {% if approval.type == 'registration' %}
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                            </svg>
                            {% else %}
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            {% endif %}
                        </span>
                    </div>
                    <div class="ml-4 flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900">
                            {{ approval.employer_name }}
                        </p>
                        <p class="text-sm text-gray-500">
                            {{ approval.type|title }} Request
                        </p>
                        <p class="text-xs text-gray-400 mt-1">
                            {{ approval.submitted_at|timesince }} ago
                        </p>
                    </div>
                    <div class="ml-4">
                        <a href="{% url 'bank:employer_approval' approval.id %}" class="inline-flex items-center px-2.5 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Review
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No pending approvals</h3>
                <p class="mt-1 text-sm text-gray-500">All requests have been processed</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Recent Transactions -->
    <div class="lg:col-span-2 bg-white rounded-lg shadow">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">Recent Transactions</h2>
                <a href="{% url 'bank:bank_trading' %}" class="text-sm text-blue-600 hover:text-blue-800">View all</a>
            </div>
            
            {% if recent_transactions %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Transaction</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for transaction in recent_transactions %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-8 w-8 bg-gray-100 rounded-full flex items-center justify-center">
                                        <span class="text-sm font-medium text-gray-600">{{ transaction.buyer.name|slice:":2" }}</span>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900">
                                            {{ transaction.buyer.name }} → {{ transaction.seller.name }}
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            ID: {{ transaction.id }}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">{{ transaction.credit_amount }} credits</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">${{ transaction.price_per_credit }}</div>
                                <div class="text-sm text-gray-500">per credit</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    {% if transaction.status == 'completed' %}bg-green-100 text-green-800
                                    {% elif transaction.status == 'pending' %}bg-yellow-100 text-yellow-800
                                    {% elif transaction.status == 'failed' %}bg-red-100 text-red-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ transaction.status|title }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ transaction.created_at|date:"M d, Y H:i" }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-8">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No transactions yet</h3>
                <p class="mt-1 text-sm text-gray-500">Transactions will appear here once they are made</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Credit Distribution -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">Credit Distribution</h2>
                <button type="button" class="text-sm text-gray-500 hover:text-gray-700">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            </div>
            <div class="h-64" id="credit-distribution-chart">
                <!-- Chart will be rendered here -->
            </div>
            <div class="mt-4 grid grid-cols-2 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-semibold text-gray-900">{{ total_employers }}</div>
                    <div class="text-sm text-gray-500">Total Employers</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-semibold text-gray-900">{{ avg_credits_per_employer }}</div>
                    <div class="text-sm text-gray-500">Avg. Credits/Employer</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Market Activity Chart
    const marketActivityCtx = document.getElementById('market-activity-chart').getContext('2d');
    new Chart(marketActivityCtx, {
            type: 'line',
            data: {
            labels: {{ chart_labels|safe }},
                datasets: [{
                label: 'Trading Volume',
                data: {{ trading_volume_data|safe }},
                borderColor: '#2563EB',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    fill: true,
                tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                        display: true,
                        drawBorder: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                    }
                    }
                }
            }
        });
        
    // Credit Distribution Chart
    const creditDistributionCtx = document.getElementById('credit-distribution-chart').getContext('2d');
    new Chart(creditDistributionCtx, {
            type: 'doughnut',
            data: {
            labels: {{ distribution_labels|safe }},
                datasets: [{
                data: {{ distribution_data|safe }},
                    backgroundColor: [
                    '#3B82F6',
                    '#10B981',
                    '#F59E0B',
                    '#EF4444',
                    '#8B5CF6'
                ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                        padding: 20
                    }
                }
            },
            cutout: '70%'
        }
    });
</script>
{% endblock %}